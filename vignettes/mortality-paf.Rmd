---
title: "Mortality PAF calculation"
author: "Ian Powell"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Mortality PAF calculation}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)

library(rpaf)
```

This vignette describes the process to calculate a *Population Attributable Fraction* (PAF) for mortality given data from a cohort study.

# Quickstart

Once the `rpaf` package has been loaded, mortality PAFs and hazard ratios can be generated with two function calls. Here we use the Mini-Finland Health Survey data as an example, and calculate the PAF for mortality when we modify smoking.

```{r}
smoke_data <- gen_data(
  indata = minifhs,
  id_var = "ID",
  ft_breaks = c(0,5,10,15,17),
  death_ind = "DEATH",
  death_time = "DEATH_FT",
  variables = c("B_COHORT", "SEX", "SMOKE"),
  period_factor = "F_PERIOD",
  time_var = "F_TIME"
)
smoke_summ <- mpaf_summary(
  sr_formula = survival::Surv(F_TIME, DEATH) ~ B_COHORT * F_PERIOD + SEX + SMOKE, 
  mpaf_data = smoke_data,
  modifications = list(SMOKE = c("Never", "<30/day", ">=30/day")),
  covar_model = c("SEX", "SMOKE")
)
smoke_summ
```

Here, one can see
 - summary output of the survival regression performed by `survival::survreg`
 - the size of the cohort and, if applicable, the number of observations removed
 - hazard ratio estimates and their confidence intervals (where reference levels are reported as `NA`)
 - a list of the modifications performed in the PAF calculations
 - PAFs for mortality over various time periods (given in the row names)


## Further information
The `mpaf_summary` object contains more information than is reported. For example, it includes the standard errors of the reported PAFs (in transformed space, \(\log(1-\text{PAF})\)), and the design frames (both raw and modified). Specific output can be accessed as from any other list in R:
```{r}
smoke_summ$se_ipaf0
```

```{r results = 'asis'}
knitr::kable(smoke_summ$design[c(33:34, 78:79, 167:168),])
knitr::kable(smoke_summ$modified[c(33:34, 78:79, 167:168),])
```
